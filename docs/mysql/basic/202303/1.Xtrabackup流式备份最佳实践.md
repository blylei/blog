---
template: overrides/blog.html
description: >
  How we rebuilt client-side search, delivering a better user experience while
  making it faster and smaller at the same time
search:
  exclude: true
hide:
  - feedback
---

# Xtrabackup流式备份最佳实践

__备份和恢复是数据库日常运维中非常重要的一项任务。如果数据库发生宕机并且没有有效的备份用来恢复数据库，
那任何由此而产生的数据丢失都可能给企业带来毁灭性的后果。有人可能会争辩说，可以通过将数据复制到多个服务器
或数据中心来防止崩溃，但设想一下，当下列异常发生时，你只能用备份来进行恢复.__ 

<aside class="mdx-author" markdown>
![@blylei][@blylei avatar]

<span>__Blylei__ · @Blylei</span>
<span>
:octicons-calendar-24: June 08, 2023 ·
:octicons-clock-24: 10 min read
</span>
</aside>

  [@blylei avatar]: https://avatars.githubusercontent.com/u/38288045

---

- 由于应用程序bug导致数据错误，且这些错误已经广播到所有从库
- 人为因素导致的数据库对象(database、table、row)被删除

## 1、目标实例启动监听

使用下面的命令在目标实例启动监听端口
```bash
[root@target ~]# nc -l -p 2222 | unpigz -c | xbstream -x -C /var/lib/mysql
```


## 2 在备份实例启动备份任务

CentOS7和以后的版本，使用systemd来启动服务。在/usr/lib/systemd/system/mysqld.service文件中，有下面的环境变量配置文件
EnvironmentFile=-/etc/sysconfig/mysql。执行下面的命令
```bash
[root@source ~]# xtrabackup --backup --stream=xbstream --parallel=4 --target-dir=/tmp | pigz -c --fast | nc -w 2 192.168.56.113 2222
```

## 3 在目标实例prepare备份集

在mysqld正常启动以后，可以使用pt-mysql-summary工具来判断，命令如下

```bash
xtrabackup --prepare  --use-memory=3G --apply-log-only --target-dir=/var/lib/mysql
```

## 4 修改备份集的文件属性

由于Xtrabackup产生的备份集，会保留原本的文件属性。在拉起实例之前，需要将备份集的文件属性进行如下修改
```bash
chown -R mysql:mysql /var/lib/mysql
```

## 5 启动备份实例

```bash
systemctl start mysqld
```