## MHA的switchover流程

[此博客根据MHA官方手册整理](https://github.com/yoshinorim/mha4mysql-manager/wiki/Sequences_of_MHA)

在执行switchover命令的时候，MHA按

### 1、检查主从设置和识别Master

- 连接到mha配置文件里面指定的所有机器上，识别出主节点的机器信息。在配置MHA时，无需手动指定Master实例的机器信息。MHA在
检查主从配置的同时，将read_only=On的实例标识为Master
  
- 在此阶段，如果发现有从库宕机，为了确保安全，脚本会退出执行

- 检查必要的脚本。在此阶段，如果那些确保MHA正常工作的脚本没有安装，则MHA会中断进程并停止持续监控

### 2、选出新主

通过第一阶段的检查以后，MHA会持续监控Master实例的健康状态。MHA不会监控Slave的状态，停止/重启/新增/移除Slave不会影响
当前的MHA监控进程，但是从拓扑里面新增或移除Slave实例时，需要更新MHA配置文件并重启MHA

### 3、原主拒绝写入

- 当MHA连接主库联系失败3次以后，进入这一阶段

- 如果在配置文件里面定义**secondary_check_script**，MHA会调用该脚本再次检查Master是否真的宕机，从而避免误判

### 4、等所有从库追平数据

- 从MHA配置文件里读取内容，连接到里面指定的所有数据库上面，再次确认是否所有Slave实例都从已经宕机的MAster复制。如果有不合法的
复制配置被探测到【eg：有Slave从其他Master进行复制】，MHA到此退出执行。如果需要避免因为从库的错误导致故障转移失败，可以在配置文件
对应数据库实例后面添加**ignore_fail**参数
  
- 检查上一次故障转移是否成功。如果上一次故障转移失败或者相隔时间较短，MHA在此停止运行并且中断故障转移流程。如果需要跳过以上检查，可以
  在**masterha_manger**命令行参数里面指定**ignore_last_failover**和**wait_on_failover_error**

### 5、在新主开启写入

- 如果已经在MHA配置文件里面指定**master_ip_failover_script**或者**shutdown_script**,MHA调用对应的脚本

- 为了避免原主突然恢复，造成脑裂，建议将原主关机 

### 6、重从库新指向新主

- 从binlog或者relaylog生成差异event，此步骤在剩余的从库上并行执行
