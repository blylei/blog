## 数据库扩展最佳实践-续

[此博客翻译自Severalnines，单击查看原文](https://severalnines.com/database-blog/best-practices-scaling-databases-part-1)

在执行switchover命令的时候，MHA按以下流程来切换主库到新的数据库实例

### 1、为什么需要扩展

- 连接到mha配置文件里面指定的所有机器上，识别出主节点的机器信息。在配置MHA时，无需手动指定Master实例的机器信息。MHA在
检查主从配置的同时，将read_only=On的实例标识为Master
  
- 在主库执行```FLUSH TABLES```刷新

- 检查是否有monitoring或者failover的进程存在

- 检查以下条件是否满足：
  
  - 所有Slave的IO线程正常运行
    
  - 所有Slave的SQL线程正常运行
  
  - 所有Slave的**Seconds_Behind_Master**状态值小于2秒
  
  - 在当前主节点的```show processlist```输出的列表里面，没有查询执行时间超过2秒

### 2、扩展方式

#### 2.1、垂直扩展
- 可以通过```--new_master_host```命令行参数显式指定新主；如果没有显式指定的话，MHA根据配置文件自动选出新主

##### 2.1.1、垂直扩展的优势
- 原主和新主必须确保binlog过滤规则一致，(binlog-do-db and binlog-ignore-db)

##### 2.1.1、垂直扩展的劣势

#### 2.2、水平扩展
- 可以通过```--new_master_host```命令行参数显式指定新主；如果没有显式指定的话，MHA根据配置文件自动选出新主

##### 2.2.1、水平扩展的优势
- 原主和新主必须确保binlog过滤规则一致，(binlog-do-db and binlog-ignore-db)

##### 2.2.1、水平扩展的劣势

### 3、扩展的前提条件

- 如果在MHA配置文件里面定义```master_ip_online_change_script```,MHA调用指定的脚本：可以在脚本里面移除可读写账号，或者```set global read_only=on```

- 在原主执行```FLUSH TABLES WITH READ LOCK```锁定整个实例来阻止数据写入。也可以设置```--skip_lock_all_tables```参数跳过此步骤
