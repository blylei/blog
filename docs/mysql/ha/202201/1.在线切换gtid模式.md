## 在线切换gtid模式
MySQL在5.6版本之后推出的gtid特性，可以有效简化主从部署、和切换的流程，此博客分享将MySQL主从从传统的(binlog_file,position)
的方式切换到基于gtid的复制模式，在MySQL5.7.6之后，可以在线切换到gtid模式

### 整体的切换流程如下：

1、在每个参与切换的MySQL实例上执行下列语句,实例无先后,等到所有实例的错误日志没有warnning告警时，进入下一步:
```bash 
mysql> SET @@GLOBAL.ENFORCE_GTID_CONSISTENCY = WARN; 
```

2、在每个参与切换的MySQL实例上执行下列语句，先主后从:
```bash
mysql> SET @@GLOBAL.ENFORCE_GTID_CONSISTENCY = ON;
```

3、在每个参与切换的MySQL实例上执行下列语句，实例无先后:
```bash
mysql> SET @@GLOBAL.GTID_MODE = OFF_PERMISSIVE;
```

4、在每个参与切换的MySQL实例上执行下列语句，实例无先后:
```bash
mysql> SET @@GLOBAL.GTID_MODE = ON_PERMISSIVE;
```

5、在每个参与切换的MySQL实例上执行下列语句，运行下列语句，查看对应的值是否为0：
```bash
mysql> show global status like 'ONGOING_ANONYMOUS_TRANSACTION_COUNT';
```
6、在主库上执行下列语句，转储binlog
```bash
mysql> flsuh logs;
```

7、在每个参与切换的MySQL实例上执行下列语句，执行下列语句，切换到gtid模式, 先主后从
```bash
mysql> SET @@GLOBAL.GTID_MODE = ON; 
```
9、在每个实例上修改/etc/my.cnf,新增|修改下列配置项
```bash
gtid_mode=ON 
enforce_gtid_consistency=ON
transaction_write_set_extraction=XXHASH64
```
10、在slave上执行下列语句，使用MASTER_AUTO_POSITION=1 替代【binlog_file,position】

```bash
mysql> stop slave;
mysql> CHANGE MASTER TO MASTER_HOST='192.168.32.102' ,MASTER_USER='repl' ,MASTER_PASSWORD='Repl_Pass_321',MASTER_AUTO_POSITION=1 for channel 'master_3'; 
mysql> start slave;				
```
	
## 监听服务连接切换
1、暂停主从同步
```bash
mysql> stop slave
```
2、获取到最新的binlog信息:gtid
```bash
mysql> show master status;
```
3、待监听服务使用gtid模式启动后，开启主从复制
```bash
mysql> start slave;
```

## 多源重建

1、执行下列语句，停止多源的主从同步
stop slave io_thread;

relaylog全部应用完以后，在暂停
stop slave;
2、执行下列语句，获取当前多源的GTID_PURGED值
SELECT @@GLOBAL.GTID_PURGED;

SET @@GLOBAL.GTID_PURGED='2143a691-30c4-11eb-acaf-005056af2229:1-544313,
75b587d2-f773-11e8-a05c-005056af2703:1-602199,
8181a1db-f78d-11e8-ad36-005056afc793:1-1254937,
b2146c29-f794-11e8-a266-005056af3080:1-80353164,
e3d53f75-f78b-11e8-833f-005056aff3f9:1-32943210';

3、从备份集获取到待新增实例的gtid_executed值


5、设置多源 GLOBAL.GTID_PURGED【合并步骤2、3的gtid-set】
SET @@GLOBAL.GTID_PURGED='2143a691-30c4-11eb-acaf-005056af2229:1-582,75b587d2-f773-11e8-a05c-005056af2703:1-2049,9147530d-cc71-11e7-934a-001b218930ee:1-1228,b2146c29-f794-11e8-a266-005056af3080:1-1676061,c34cf583-f78f-11e8-a02b-005056af6833:1-322175,e3d53f75-f78b-11e8-833f-005056aff3f9:1-310585';

6、创建待新增实例的复制通道
CHANGE MASTER TO MASTER_HOST='172.16.32.103'
                ,MASTER_USER='repl'
				,MASTER_PASSWORD='Nk&Z5prrQSQC'
				,MASTER_AUTO_POSITION=1 
				for channel 'master_103';

7、启动多源上的所有通道
start slave;				



